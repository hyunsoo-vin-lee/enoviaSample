define("UWA/Controls/AudioPlayer",["UWA/Core","UWA/Utils","UWA/Utils/Client","UWA/Event","UWA/Element","UWA/Controls/Abstract","UWA/Controls/Flash","UWA/Controls/Slider"],function(d,i,b,j,a,g,c,e){var k=0;var h;function f(n){var p,l,o=h.Adapter;var m=i.parseUrl(n);for(p in o){if(o.hasOwnProperty(p)){if(!l&&o[p].isAvailable(m.fileName)){l=o[p]}}}return l}h=g.extend({name:"uwa-audioplayer",defaultOptions:{url:"",autoPlay:false,handleButton:true,closeButton:true,preload:"none",className:"",isTouch:b.Features.touchEvents,player:{html:[{tag:"div","class":"uwa-icon play-pause"},{tag:"div","class":"controls-times",html:[{tag:"span","class":"played",text:"00:00"},{tag:"span","class":"duration duration-hide",text:"00:00"}]},{tag:"div","class":"controls-slider"},{tag:"div","class":"controls-right",html:{tag:"div","class":"uwa-icon close close-hide"}}],playPauseClass:"play-pause",timeClass:"time",durationClass:"duration",playedClass:"played",errorMessageClass:"error-message",playingClass:"playing",waitingClass:"waiting",errorClass:"error",closeClass:"close"}},adapter:null,init:function(l){var m=this;this.id=k;k++;d.Controls.AudioPlayer.Instances["x"+this.id]=this;l=l||{};this._parent(l);this.eventNames={start:this.options.isTouch?"touchstart":"mousedown",move:this.options.isTouch?"touchmove":"mousemove",end:this.options.isTouch?"touchend":"mouseup"};this.body=l.body||document.body;this.buildSkeleton();this.attachEvents();this.reset();if(this.options.url){this[this.options.autoPlay?"play":"load"]()}this.container.addEvent("resize",function(){var o=30,n=10,s=7,q,v,w,p,t,u,r;q=m.elements;q.slider.show();q.controlsTimes.show();q.controlsRight.show();v=m.container.getSize().width;w=q.playPause.getSize().width;p=q.slider.getSize().width;t=q.controlsTimes.getSize().width;u=q.controlsRight.getSize().width;if(p<o){q.slider.hide();r=w+t+u;if(r>v-n){q.controlsTimes.hide();r-=t;if(r>v-s){q.controlsRight.hide()}}}})},getAdapter:function(m){var l=f(m);if(!l){window.open(m)}else{if(!this.adapter){this.adapter=l.build(this)}this.adapter.setUrl(m);return this.adapter}},buildSkeleton:function(){var m,o,p=this,n=p.options,l=n.player;m=d.createElement("div",{"class":this.getClassNames(),html:n.player.html});o=m.getElement.bind(m);p.elements={playPause:o(".play-pause"),slider:null,controlsTimes:o(".controls-times"),controlsRight:o(".controls-right"),played:o("."+l.playedClass),duration:o("."+l.durationClass),play:o("."+l.playPauseClass),close:o("."+l.closeClass)};if(p.options.closeButton){p.elements.close.removeClassName("close-hide")}p.container=m;return p},attachEvents:function(){var l=this,m=l.elements,n=l.dispatchEvent.bind(l);m.play.addEvent("click",n.bind(l,"onPlayPause"));if(this.options.closeButton){m.close.addEvent("click",n.bind(l,"close"))}l.slider=new e({_root:false,container:l.container,events:{onChange:function(p){var o=(p*l.adapter.getDuration())/100;l.adapter.setCurrentTime(o);m.played.setText(l.formatTime(o))}}});l.elements.slider=l.slider.elements.scrubber;return this},reset:function(){var l=this,m=l.elements;l.loadedPercent=0;l.canPlay=false;l.shouldPlay=false;m.duration.setText(l.formatTime(0));m.played.setText(l.formatTime(0))},load:function(l){l=l||this.options.url;this.stop();this.reset();this.show();this.adapter=this.getAdapter(l)},play:function(l,m){this.load(l,m);if(this.adapter){this.adapter.play();this.shouldPlay=true}},pause:function(){if(this.adapter){this.adapter.pause()}this.shouldPlay=false},stop:function(){if(this.adapter){this.adapter.stop();this.slider.reset()}},close:function(){this.stop();this.slider.reset();this.hide()},onPlayPause:function(){if(this.adapter){this.adapter[this.adapter.isPaused()?"play":"pause"]()}},onPlay:function(){this.container.addClassName(this.options.player.playingClass).removeClassName("paused");if(!this.canPlay){this.container.addClassName(this.options.player.waitingClass)}this.shouldPlay=true},onPause:function(){this.container.removeClassName(this.options.player.waitingClass).removeClassName(this.options.player.playingClass).addClassName("paused");this.shouldPlay=false},onCanPlay:function(){if(this.options.preload||this.options.preload!=="none"){this.trackLoadProgress()}this.container.removeClassName(this.options.player.waitingClass);this.canPlay=true;if(this.shouldPlay&&this.adapter&&this.adapter.isPaused()){this.adapter.play()}},onMetadataLoaded:function(){this.elements.duration.setText(this.formatTime(this.adapter.getDuration()))},onTimeUpdate:function(){this.elements.played.setText(this.formatTime(this.adapter.getCurrentTime()));var l=this.adapter.getCurrentTime()*100/this.adapter.getDuration();this.slider.setValue(l)},trackLoadProgress:function(){if(this.loadTimer){clearTimeout(this.loadTimer)}if(this.loadedPercent<1){this.loadTimer=setTimeout(function(){this.onLoadProgress();this.trackLoadProgress()}.bind(this),400)}},onLoadProgress:function(){this.loadedPercent=this.adapter?this.adapter.getLoadProgress():0;if(this.loadedPercent){this.slider.setLoadedValue(this.loadedPercent)}},formatTime:function(n){var o=parseInt(n,10),m=Math.floor(o/60,10),l=o-m*60;l=!isNaN(l)?l:0;m=!isNaN(m)?m:0;return m+":"+(l<10?"0"+l:l)}});h.canPlay=function(l){return Boolean(f(l))};h.Instances={};h.Adapter={audio:{audioTag:null,isAvailable:function(l){var m=document.createElement("audio");if(m.canPlayType){return(/\.mp3$/.test(l)&&""!==m.canPlayType("audio/mpeg"))||(/\.m4a$/.test(l)&&""!==m.canPlayType("audio/x-m4a"))||(/\.ogg$/.test(l)&&""!==m.canPlayType('audio/ogg; codecs="vorbis"'))}return false},build:function(l){this.audioTag=d.createElement("audio",{id:"uwa-audioplayer-audio-"+l.id,preload:l.options.preload,events:{play:l.onPlay.bind(l),pause:l.onPause.bind(l),ended:function(){l.pause();l.elements.played.setText(l.formatTime(0));l.slider.reset()},timeupdate:function(){l.dispatchEvent("onTimeUpdate");l.onLoadProgress()},loadedmetadata:l.onMetadataLoaded.bind(l),canplay:l.dispatchEvent.bind(l,"onCanPlay")}}).setStyles({position:"absolute",top:"-100000px"});this.audioTag.inject(l.container);return this},isPaused:function(){return this.audioTag.paused},play:function(){this.audioTag.play()},pause:function(){this.audioTag.pause()},stop:function(){this.audioTag.pause()},setCurrentTime:function(m){try{this.audioTag.currentTime=m}catch(l){}},getCurrentTime:function(){return this.audioTag.currentTime},getDuration:function(){return this.audioTag.duration},getLoadProgress:function(){var m=0,l=this.audioTag;if(l&&l.buffered&&l.buffered.length>0&&l.buffered.end&&l.duration){m=l.buffered.end(0)/l.duration}else{if(l&&l.bytesTotal!==undefined&&l.bytesTotal>0&&l.bufferedBytes!==undefined){m=l.bufferedBytes/l.bytesTotal}}return m*100},setVolume:function(l){this.audioTag.volume=parseFloat(l/200)},getVolume:function(){return this.audioTag.volume*200},setUrl:function(l){this.audioTag.src=l;this.audioTag.load()}},flash:{flashTag:null,isAvailable:function(l){return c.prototype.detectFlashVersion().major!==0&&/\.mp3$/.test(l)},build:function(p){var m,n="uwa-audioplayer-flash-"+p.id,l=new c({_root:false,id:n,url:d.hosts.uwa+"/lib/UWA/assets/img/flash/player_mp3_js.swf",width:1,height:1,flashVars:"listener=UWA.Controls.AudioPlayer.Instances.x"+p.id+".adapter.listener&interval=750&userexternalinterface=1",allowScriptAccess:"always"});this.pendingVariables=[];this.control=p;this.listener={isPlaying:false,ready:false,onInit:this.onReady.bind(this),onUpdate:function(){p.onMetadataLoaded();p.dispatchEvent("onTimeUpdate");p.onLoadProgress()}};this.flashTag=l.getFlashContainer();this.flashTag.setStyles({position:"absolute",top:"-100000px"});if(b.Engine.ie){try{m=document.createElement("<script for="+n+" event=FSCommand(command,args)><\/script>");m.text="eval(args);";document.body.appendChild(m)}catch(o){}}this.flashTag.inject(p.container);return this},SetVariable:function(l,n){var m=this;if(!m.listener.ready){m.pendingVariables.push([l,n]);return}m.variableTimers=m.variableTimers||{};try{clearTimeout(m.variableTimers[l]);m.flashTag.SetVariable(l,n)}catch(o){m.variableTimers[l]=setTimeout(function(){m.flashTag.SetVariable(l,n)},500)}},onReady:function(){this.listener.ready=true;this.pendingVariables.forEach(function(l){this.SetVariable.apply(this,l)},this);this.control.dispatchEvent("onCanPlay")},isPaused:function(){return this.listener.isPlaying!=="true"},play:function(){this.SetVariable("enabled","true");this.SetVariable("method:play");this.control.onPlay()},pause:function(){this.SetVariable("method:pause");this.control.onPause()},stop:function(){this.SetVariable("method:setPosition",0);this.SetVariable("method:stop");this.control.onPause()},setCurrentTime:function(l){this.SetVariable("enabled","false");this.SetVariable("method:setPosition",Math.round(l*1000));this.SetVariable("enabled","true")},getCurrentTime:function(){return this.listener.position/1000},getDuration:function(){return this.listener.duration/1000},getLoadProgress:function(){var l=this.listener.bytesPercent;return isNaN(l)?100:l},setVolume:function(l){l=(!isNaN(l)?l:100);this.SetVariable("method:setVolume",l)},getVolume:function(){return this.listener.volume},setUrl:function(l){this.SetVariable("method:setUrl",l)}}};return d.namespace("Controls/AudioPlayer",h,d)});