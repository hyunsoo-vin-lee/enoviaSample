define("UWA/Controls/DataGrid",["UWA/Core","UWA/Event","UWA/String","UWA/Element","UWA/Controls/Abstract","UWA/Controls/Scroller"],function(f,j,c,b,g,d){var e=new WeakMap();function h(l){var k=f.createElement(l.tag||"th",{"class":l.dataIndex,html:{tag:"span",html:l.text}});if(l.sortable){var m=f.createElement("span",{"class":"sort",text:""}).inject(k);k.addClassName("sortable");if(l.isSorted){m.setText(l.sortReverse?"D":"E")}}else{k.addClassName("no-sortable");if(!l.text){k.addClassName("empty")}}if(l.className){k.addClassName(l.className)}if(l.isFirst){k.addClassName("first")}if(l.color){k.setStyles({"background-color":l.color,color:"#FFFFFF"})}return k}function a(m){var k=f.createElement(m.tag||"td",{"class":m.dataIndex,"data-itemId":m.itemId,html:m.format?m.format(m.text):m.text});if(m.className){k.addClassName(m.className)}if(m.isFixed){k.addClassName("is-fixed")}if(m.isFirst){k.addClassName("first")}else{k.addClassName("grid-data")}if(m.color){var l=c.hexToRgb(m.color,true);k.setStyle("background-color","rgba("+l.toString()+",0.2)")}return k}var i=g.extend({defaultOptions:{className:"",data:null,columns:null,sortable:false,orderBy:"",sortReverse:false,scrollerOptions:{}},name:"uwa-datagrid",dataGrid:null,columns:null,init:function(k){this._parent(k);this.dataGrid=k.data;this.columns=k.columns;this.buildSkeleton();this.fillGrid();this.initEvents()},setScrollerSize:function(k){if(this.scroller){this.scroller.setSize(k)}},buildSkeleton:function(){var k=this.options,l=this.elements;l.container=f.createElement("div",{"class":this.getClassNames()});l.grid=f.createElement("table",{"class":this.getClassNames("-table")}).inject(l.container);if(k.sortable){l.grid.addClassName("sortable")}},initEvents:function(){this.elements.container.addEvent("click",this.handleEvent.bind(this))},handleEvent:function(k){var l=j.getElement(k).getClosest("th");if(this.options.sortable&&l&&!l.hasClassName("no-sortable")){this.onOrderColumn(l.className.split(" ")[0])}},fillGrid:function(){this.fillHeader();this.fillBody()},fillHeader:function(){var n,m,p,o=this.elements,k=this.columns;o.grid.empty();p=f.createElement("tr").inject(o.grid);for(n=0,m=k.length;n<m;n++){h({isSorted:this.options.orderBy===k[n].dataIndex,sortReverse:this.options.sortReverse,className:k[n].className,dataIndex:k[n].dataIndex,text:k[n].text,isFirst:k[n].isFirst,sortable:this.options.sortable&&!k[n].noSortable,color:k[n].color}).inject(p)}},fillBody:function(){var r,n,p,o,s,m=this.elements,v=this.options,t=this.columns,q=this.dataGrid;if(v.sortable&&v.orderBy){q=this.sortData()}for(r=0,n=q.length;r<n;r++){s=f.createElement("tr").inject(m.grid);for(p=0,o=t.length;p<o;p++){var u=q[r][t[p].dataIndex];a({text:u,isFixed:q[r].isFixed||t[p].isFixed,className:(q[r].className||"")+" "+(t[p].className||""),dataIndex:t[p].dataIndex,itemId:f.is(u,"object")&&u.itemId,format:t[p].format,isFirst:t[p].isFirst,color:t[p].color}).inject(s)}}},sortData:function(){var l=this.options,m=this.dataGrid,k=this.columns.filter(function(n){return n.dataIndex===l.orderBy})[0];if(!k){throw new Error("Sort column was not found : "+l.orderBy)}m.sort(function(o,n){var q,p;q=k.sortKey?k.sortKey(o[l.orderBy]):o[l.orderBy];p=k.sortKey?k.sortKey(n[l.orderBy]):n[l.orderBy];if(q<p){return(!l.sortReverse)?-1:1}if(q>p){return(!l.sortReverse)?1:-1}return 0});return m},onOrderColumn:function(l){var k=this.options;if(k.orderBy===l){k.sortReverse=!k.sortReverse}else{k.sortReverse=false}k.orderBy=l;this.fillGrid();if(this.scroller){this.scroller.updateFixedHeaders(this.elements.grid)}this.dispatchEvent("updateSortOptions",k)},updateData:function(k,l){this.dataGrid=l;this.columns=k;this.fillGrid();if(this.scroller){this.updateScroller()}},addScroller:function(){this.scroller=new i.GridScroller(this.elements.grid,f.extend({_root:false},this.options.scrollerOptions));this.scroller.addEvent("onRefresh",function(k){if(k&&k.target===this.elements.grid){this.scroller.setFixedHeaderSizes()}}.bind(this))},updateScroller:function(){if(this.scroller){this.scroller.destroy()}this.addScroller()}});i.GridScroller=d.extend({defaultOptions:{lockDirection:false},init:function(k){this._parent.apply(this,arguments);this.updateFixedHeaders(k)},_buildFixedHeaders:function(k){var n=this._getFixedHeadersSize(k),m=n.top,l=n.left;if(n.left){n.left=this._buildFixedHeader(k,n.left,Infinity)}if(n.bottom){n.bottom=this._buildFixedHeader(k,Infinity,-n.bottom)}if(n.right){n.right=this._buildFixedHeader(k,-n.right,Infinity)}if(n.top){n.top=this._buildFixedHeader(k,Infinity,n.top);if(n.left){n.topLeft=this._buildFixedHeader(k,l,m)}}this._fixedHeaders=n},_isHeaderCell:function(k){return b.getTagName.call(k)==="th"||b.hasClassName.call(k,"is-fixed")},_getFixedHeadersSize:function(m){var k={top:0,bottom:0,left:Infinity,right:Infinity},n=true,l=this;b.getElements.call(m,"tr").forEach(function(q){var r=0,o=0,p=true;b.getChildren.call(q).forEach(function(s){if(l._isHeaderCell(s)){if(p){r++}o++}else{p=false;o=0}});k.left=Math.min(k.left,r);k.right=Math.min(k.right,o);if(p){if(n){k.top++}k.bottom++}else{n=false;k.bottom=0}});return k},setFixedHeaderSizes:function(){var k=[];Object.keys(this._fixedHeaders).forEach(function(m){var l=this._fixedHeaders[m];if(!l){return}var n={width:0,height:0};b.getElements.call(l,"tr").forEach(function(p,q){var o=b.getDimensions.call(e.get(p));n.height+=o.outerHeight;b.getChildren.call(p).forEach(function(r){var s=b.getDimensions.call(e.get(r));k.push({element:r,size:{width:s.innerWidth,height:s.innerHeight}});if(q===0&&!r.isHidden()){n.width+=s.outerWidth}})});k.push({element:l,size:n})},this);k.forEach(function(l){b.setStyles.call(l.element,l.size)})},_buildFixedHeader:function(o,m,l){function p(r,q){return q<0?r.slice(q):r.slice(0,q)}var k,n={tag:"tbody",html:[]};p(b.getElements.call(o,"tr"),l).forEach(function(r){var q=f.createElement("tr");e.set(q,r);n.html.push(q);p(b.getChildren.call(r),m).forEach(function(s){var t=s.cloneNode(true);e.set(t,s);q.grab(t)})});k=o.cloneNode();b.setHTML.call(k,n);b.addClassName.call(k,"fixed-column");this.elements.scroller.grab(k);return k},_updateHeaderPositions:function(k){var l=this._fixedHeaders;if(l.top){b.setPosition.call(l.top,{y:0,x:k.x})}if(l.left){b.setPosition.call(l.left,{y:k.y,x:0})}if(l.right){b.setPosition.call(l.right,{y:k.y,x:this.scroll.width-b.getSize.call(l.right).width})}if(l.bottom){b.setPosition.call(l.bottom,{x:k.x,y:this.scroll.height-b.getSize.call(l.bottom).height})}if(l.topLeft){b.setPosition.call(l.topLeft,{y:0,x:0})}},updateFixedHeaders:function(k){var l;if(this._fixedHeaders){for(l in this._fixedHeaders){if(this._fixedHeaders[l]){b.destroy.call(this._fixedHeaders[l])}}}this._buildFixedHeaders(k);this.setFixedHeaderSizes();this._updateHeaderPositions(this.position)},onScroll:function(){this._parent.apply(this,arguments);this._updateHeaderPositions(this.getPosition(true))}});return f.namespace("Controls/DataGrid",i,f)});