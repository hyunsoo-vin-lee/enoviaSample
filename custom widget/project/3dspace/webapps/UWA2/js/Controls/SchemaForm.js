define("UWA/Controls/SchemaForm",["UWA/Core","UWA/Array","UWA/Class","UWA/Promise","UWA/Controls/Abstract","UWA/Controls/ToolTip","UWA/Controls/SchemaForm/Inputs","UWA/Controls/SchemaForm/Sanitizers","UWA/Controls/SchemaForm/Validators","UWA/Controls/Input"],function(e,b,a,j,g,k,l,d,c,i){var f,h;f=g.extend({name:"uwa-schemaform",fields:null,onChangePaused:false,isPropagatingChanges:false,options:{schema:null,initialValue:{},inputs:l,sanitizers:d,validators:c,submitButton:true,clearButton:false,data:null,baseInputOptions:{}},init:function(m){this._parent(m);this._initFields()},_initFields:function(){this.fields={};Object.keys(this.options.schema.fields).forEach(function(n){var m=this.options.initialValue&&this.options.initialValue[n];this.fields[n]=new h(this,n,this.options.schema.fields[n],m)},this)},getContent:function(){if(!this.elements.container){this._buildContent()}return this.elements.container},buildNotice:function(n,m,o){m=m?m:"tooltip";if(!this.notices[o]){this.notices[o]=e.createElement("div",{"class":this.getClassNames("-notice uwa-icon "+m),"uwa-tooltip":n,"uwa-tooltip-delay":"10"})}else{this.notices[o].setAttribute("uwa-tooltip",n)}this.notices[o].inject(o?this.fields[o].getContent():this.elements.container)},_buildContent:function(){var m=this;this.elements.container=e.createElement("div",{"class":this.getClassNames()});this.notices={};if(this.options.schema.notice){this.buildNotice(this.options.schema.notice.text,this.options.schema.notice.icon)}Object.keys(this.fields).forEach(function(n){this.elements.container.addContent(this.fields[n].getContent());if(this.fields[n].schema.input.options&&this.fields[n].schema.input.options.hidden){this.fields[n].getContent().hide()}},this);if(this.options.submitButton||this.options.clearButton){this.elements.buttonContainer=e.createElement("div",{"class":this.getClassNames("-buttons")}).inject(this.elements.container);if(this.options.clearButton){this.elements.clearButton=new i.Button(e.merge({_root:false,value:"Clear",events:{onClick:function(){m.clearValue()}}},this.options.baseInputOptions)).inject(this.elements.buttonContainer)}if(this.options.submitButton){this.elements.submitButton=new i.Button(e.merge({_root:false,value:"Submit",events:{onClick:function(){m.isValid().then(function(){m.dispatchEvent("onSubmit",[{value:m.getValue()}])})}}},this.options.baseInputOptions)).inject(this.elements.buttonContainer)}}return this.elements.container},getValue:function(){var m={};Object.keys(this.fields).forEach(function(o){var n=this.fields[o].getValue();if(!n&&!e.is(n,"boolean")){n=null}m[o]=n},this);return m},getDisplayValue:function(){var m={};Object.keys(this.fields).forEach(function(n){m[n]=this.fields[n].getDisplayValue()},this);return m},getFieldValue:function(n){var m=this.fields[n];return m?m.getValue():null},getAllFieldsName:function(){return Object.keys(this.fields)},setFieldValue:function(n,m){if(this.fields[n]){this.fields[n].setValue(m);this._onFieldChanged(n)}},setFieldTitle:function(n,m){if(this.fields[n]){this.fields[n].setTitle(m)}},getValidatedValue:function(){var m=this.getValue();return this.isValid().then(function(){return m})},getValidatedFieldValue:function(n){var m=this.fields[n];return m.isValid().then(function(){return m.getValue()})},setValue:function(m){this.onChangePaused=true;m=m||{};Object.keys(this.fields).forEach(function(n){if(m.hasOwnProperty(n)){this.fields[n].setValue(m[n])}},this);this.updateValidityMessages();this.onChangePaused=false},clearValue:function(){this.onChangePaused=true;Object.keys(this.fields).forEach(function(m){this.fields[m].setValue(null)},this);this.updateValidityMessages();this.onChangePaused=false},isValid:function(){return j.allSettled(Object.keys(this.fields).map(function(m){return this.fields[m].isValid().fail(function(n){return j.reject(Object.assign(n,{fieldName:m}))})},this)).then(function(m){var n={};m.forEach(function(o){if(o.state==="rejected"){n[o.reason.fieldName]=o.reason}});if(Object.keys(n).length!==0){throw Object.assign(new Error("There is an error within a field"),{fieldErrors:n})}})},updateValidityMessages:function(){Object.keys(this.fields).forEach(function(m){this.fields[m].updateValidityMessage({forceValidation:true})},this)},getSchemaformData:function(){return this.options.data},_createContextForField:function(){var m={getFieldValue:this.getFieldValue.bind(this),setFieldValue:this.setFieldValue.bind(this),getAllFieldsName:this.getAllFieldsName.bind(this),getValidatedFieldValue:this.getValidatedFieldValue.bind(this),getSchemaformData:this.getSchemaformData.bind(this),hideField:this.hideField.bind(this),showField:this.showField.bind(this),buildNotice:this.buildNotice.bind(this),addValidityMessage:this.addValidityMessage.bind(this),hideValidityMessage:this.hideValidityMessage.bind(this),setFieldTitle:this.setFieldTitle.bind(this)};return m},addValidityMessage:function(n,m){if(this.fields[n]){this.fields[n].addValidityMessage(m)}},hideValidityMessage:function(m){if(this.fields[m]){this.fields[m].hideValidityMessage()}},hideField:function(m){if(this.fields[m]){this.fields[m].getContent().hide()}},showField:function(m){if(this.fields[m]){this.fields[m].getContent().show()}},_executeSanitizers:function(q,o,p){var n=this;var m=p;var r=this._getSanitizersFor(q);r.forEach(function(u){var t=n._evaluateOptions(u,o),s=n.options.sanitizers[u.id];m=s(m,t)});return m},_executeValidators:function(r,p,q){var o=this;var m;var n=this._getValidatorsFor(r);m=j.all(n.map(function(s){var v=o._evaluateOptions(s,p),t=o.options.validators[s.id],u=t.bind(null,q,v,r);return j.resolve().then(u)}));return m},_getSanitizersFor:function(m){return m.sanitizers?m.sanitizers:m.sanitizer?[m.sanitizer]:[]},_getValidatorsFor:function(m){return m.validators?m.validators:m.validator?[m.validator]:[]},_evaluateOptions:function(s,r){var n;if(s.computedOptions){n={};var m=s.computedOptions;for(var q in m){if(m.hasOwnProperty(q)){var t=m[q],o=t.sourceFieldName,p=this.getFieldValue(o);p=this._executeSanitizers(t,r,p);n[q]=p}}if(s.options){n=e.merge(n,s.options)}}else{if(s.options){n=s.options}else{n={}}}n=e.merge(n,{context:r});return n},_findDependencies:function(r){if(!r){return[]}var v=[];if(r.computedOptions){var t=r.computedOptions;for(var n in t){if(t.hasOwnProperty(n)){var q=t[n],p=this._getSanitizersFor(q);if(typeof(q.sourceFieldName)==="string"&&q.sourceFieldName!==""){v.push(q.sourceFieldName)}if(p){for(var u=0;u<p.length;u++){var m=p[u],o=this._findDependencies(m);v=v.concat(o)}}}}}return v},_onFieldChanged:function(m){if(this.isPropagatingChanges){return}this._propagateChanges([m]);if(!this.onChangePaused){this.dispatchEvent("onChange",[{value:this.getValue()}])}},_propagateChanges:function(o){this.isPropagatingChanges=true;var n=0;while(o.length){var r=[];for(var p=0;p<Object.keys(this.fields).length;p++){var s=Object.keys(this.fields)[p],q=this.fields[s],m=q.onFieldsChanged(o);if(m){r.push(s)}}o=r;if(++n>500){throw new Error("I reckon there might be some good old cyclical references in your computedOptions, partner.")}}this.isPropagatingChanges=false},destroy:function(){Object.keys(this.fields).forEach(function(m){this.fields[m].destroy()},this);this._parent()}});h=a.extend({host:null,schema:null,elements:null,fallbackValue:undefined,context:null,dependencies:null,validationCacheIsFor:null,cachedValidationPromise:null,init:function(p,r,q,n){var o=this;this.host=p;this.schema=q;this.name=r;this.elements={};this.fallbackValue=n;this.context=p._createContextForField(this);function m(t){var s=[];t.forEach(function(u){s=s.concat(o.host._findDependencies(u))});return s}this.dependencies={input:this.host._findDependencies(this.schema.input),sanitizer:m(this.host._getSanitizersFor(this.schema)),validator:m(this.host._getValidatorsFor(this.schema))}},getContent:function(){if(!this.elements.container){this._buildContent()}return this.elements.container},_buildContent:function(){this.elements.container=e.createElement("div",{"class":this.host.getClassNames("-field")+" input-"+this.schema.input.id});this.elements.validityMessage=e.createElement("div",{"class":this.host.getClassNames("-field-validity-message")}).inject(this.elements.container);this.elements.title=e.createElement("div",{"class":this.host.getClassNames("-field-title"),text:this.schema.title}).inject(this.elements.container);this.elements.inputWrapper=e.createElement("div",{"class":this.host.getClassNames("-field-wrapper")}).inject(this.elements.container);this._buildInput();if(this.schema.notice){this.context.buildNotice(this.schema.notice.text,this.schema.notice.icon,this.name)}},setTitle:function(m){if(this.elements.title){this.elements.title.setText(m)}},_buildInput:function(){if(this.elements.control){this.elements.control.destroy();this.elements.inputWrapper.empty()}var n=this.host.options.inputs[this.schema.input.id];var m=e.clone(this.host._evaluateOptions(this.schema.input,this.context));m=Object.assign({},this.host.options.baseInputOptions,m,{_root:false,context:this.context,schema:this.schema,name:this.name});if(this.fallbackValue){Object.assign(m,{value:this.fallbackValue})}this.elements.control=new n(m).inject(this.elements.inputWrapper);if(this.elements.control.addEvent){this.elements.control.addEvent("onChange",function(){this.fallbackValue=this.elements.control.getValue();this.updateValidityMessage();this.host._onFieldChanged(this.name)},this)}},_isValidationCacheUpToDate:function(){return(this.cachedValidationPromise&&this.validationCacheIsFor===this._getRawValue())},getValue:function(){return this._sanitize(this._getRawValue())},getDisplayValue:function(){if(this.elements.control&&this.elements.control.getDisplayValue){return this.elements.control.getDisplayValue()}else{return this._getRawValue()}},_getRawValue:function(){if(this.elements.control){return this.elements.control.getValue()}else{return this.fallbackValue}},_sanitize:function(m){return this.host._executeSanitizers(this.schema,this.context,m)},setValue:function(m){if(this.elements.control){this.elements.control.setValue(m)}else{this.fallbackValue=m}},isEmpty:function(){if(this.elements.control){return this.elements.control.isEmpty()}return true},isValid:function(){var m=this.host._getValidatorsFor(this.schema).filter(function(n){return n.id==="one-of"}).length;if(!this._isValidationCacheUpToDate()||m){this.validationCacheIsFor=this._getRawValue();this.cachedValidationPromise=this.host._executeValidators(this.schema,this.context,this.getValue())}return this.cachedValidationPromise},updateValidityMessage:function(n){var m=this;if(this.fallbackValue!==undefined||(n&&n.forceValidation)){this.isValid().then(function(){m.hideValidityMessage()},function(o){m.addValidityMessage(o)})}},addValidityMessage:function(m){if(this.elements.validityMessage){this.elements.validityMessage.textContent=m.message;this.elements.container.addClassName("invalid")}},hideValidityMessage:function(){if(this.elements.validityMessage){this.elements.validityMessage.textContent="";this.elements.container.removeClassName("invalid")}},onFieldsChanged:function(p){var o=this;var n=false;function m(r){var q=o.dependencies[r];return p.some(function(s){return q.indexOf(s)>-1})}if(m("input")&&this.elements.container){n=true;this._buildInput()}if(m("sanitizer")){n=true}if(m("validator")){this.validationCacheIsFor=null;this.updateValidityMessage()}return n},destroy:function(){if(this.elements.container){this.elements.container.destroy();if(this.elements.control.destroy){this.elements.control.destroy()}}}});return e.namespace("Controls/SchemaForm",f,e,"replace")});